(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const A=Object.create(null);A.open="0";A.close="1";A.ping="2";A.pong="3";A.message="4";A.upgrade="5";A.noop="6";const $=Object.create(null);Object.keys(A).forEach(s=>{$[A[s]]=s});const ee={type:"error",data:"parser error"},Ce=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",_e=typeof ArrayBuffer=="function",Te=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s&&s.buffer instanceof ArrayBuffer,ae=({type:s,data:e},t,i)=>Ce&&e instanceof Blob?t?i(e):pe(e,i):_e&&(e instanceof ArrayBuffer||Te(e))?t?i(e):pe(new Blob([e]),i):i(A[s]+(e||"")),pe=(s,e)=>{const t=new FileReader;return t.onload=function(){const i=t.result.split(",")[1];e("b"+(i||""))},t.readAsDataURL(s)};function me(s){return s instanceof Uint8Array?s:s instanceof ArrayBuffer?new Uint8Array(s):new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}let J;function Fe(s,e){if(Ce&&s.data instanceof Blob)return s.data.arrayBuffer().then(me).then(e);if(_e&&(s.data instanceof ArrayBuffer||Te(s.data)))return e(me(s.data));ae(s,!1,t=>{J||(J=new TextEncoder),e(J.encode(t))})}const ge="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",N=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let s=0;s<ge.length;s++)N[ge.charCodeAt(s)]=s;const Ge=s=>{let e=s.length*.75,t=s.length,i,n=0,o,r,a,c;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);const h=new ArrayBuffer(e),u=new Uint8Array(h);for(i=0;i<t;i+=4)o=N[s.charCodeAt(i)],r=N[s.charCodeAt(i+1)],a=N[s.charCodeAt(i+2)],c=N[s.charCodeAt(i+3)],u[n++]=o<<2|r>>4,u[n++]=(r&15)<<4|a>>2,u[n++]=(a&3)<<6|c&63;return h},He=typeof ArrayBuffer=="function",le=(s,e)=>{if(typeof s!="string")return{type:"message",data:ke(s,e)};const t=s.charAt(0);return t==="b"?{type:"message",data:We(s.substring(1),e)}:$[t]?s.length>1?{type:$[t],data:s.substring(1)}:{type:$[t]}:ee},We=(s,e)=>{if(He){const t=Ge(s);return ke(t,e)}else return{base64:!0,data:s}},ke=(s,e)=>e==="blob"?s instanceof Blob?s:new Blob([s]):s instanceof ArrayBuffer?s:s.buffer,we="",Xe=(s,e)=>{const t=s.length,i=new Array(t);let n=0;s.forEach((o,r)=>{ae(o,!1,a=>{i[r]=a,++n===t&&e(i.join(we))})})},Ye=(s,e)=>{const t=s.split(we),i=[];for(let n=0;n<t.length;n++){const o=le(t[n],e);if(i.push(o),o.type==="error")break}return i};function je(){return new TransformStream({transform(s,e){Fe(s,t=>{const i=t.length;let n;if(i<126)n=new Uint8Array(1),new DataView(n.buffer).setUint8(0,i);else if(i<65536){n=new Uint8Array(3);const o=new DataView(n.buffer);o.setUint8(0,126),o.setUint16(1,i)}else{n=new Uint8Array(9);const o=new DataView(n.buffer);o.setUint8(0,127),o.setBigUint64(1,BigInt(i))}s.data&&typeof s.data!="string"&&(n[0]|=128),e.enqueue(n),e.enqueue(t)})}})}let Q;function V(s){return s.reduce((e,t)=>e+t.length,0)}function D(s,e){if(s[0].length===e)return s.shift();const t=new Uint8Array(e);let i=0;for(let n=0;n<e;n++)t[n]=s[0][i++],i===s[0].length&&(s.shift(),i=0);return s.length&&i<s[0].length&&(s[0]=s[0].slice(i)),t}function Ke(s,e){Q||(Q=new TextDecoder);const t=[];let i=0,n=-1,o=!1;return new TransformStream({transform(r,a){for(t.push(r);;){if(i===0){if(V(t)<1)break;const c=D(t,1);o=(c[0]&128)===128,n=c[0]&127,n<126?i=3:n===126?i=1:i=2}else if(i===1){if(V(t)<2)break;const c=D(t,2);n=new DataView(c.buffer,c.byteOffset,c.length).getUint16(0),i=3}else if(i===2){if(V(t)<8)break;const c=D(t,8),h=new DataView(c.buffer,c.byteOffset,c.length),u=h.getUint32(0);if(u>Math.pow(2,21)-1){a.enqueue(ee);break}n=u*Math.pow(2,32)+h.getUint32(4),i=3}else{if(V(t)<n)break;const c=D(t,n);a.enqueue(le(o?c:Q.decode(c),e)),i=0}if(n===0||n>s){a.enqueue(ee);break}}}})}const ze=4;function b(s){if(s)return Je(s)}function Je(s){for(var e in b.prototype)s[e]=b.prototype[e];return s}b.prototype.on=b.prototype.addEventListener=function(s,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+s]=this._callbacks["$"+s]||[]).push(e),this};b.prototype.once=function(s,e){function t(){this.off(s,t),e.apply(this,arguments)}return t.fn=e,this.on(s,t),this};b.prototype.off=b.prototype.removeListener=b.prototype.removeAllListeners=b.prototype.removeEventListener=function(s,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+s];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+s],this;for(var i,n=0;n<t.length;n++)if(i=t[n],i===e||i.fn===e){t.splice(n,1);break}return t.length===0&&delete this._callbacks["$"+s],this};b.prototype.emit=function(s){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+s],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(t){t=t.slice(0);for(var i=0,n=t.length;i<n;++i)t[i].apply(this,e)}return this};b.prototype.emitReserved=b.prototype.emit;b.prototype.listeners=function(s){return this._callbacks=this._callbacks||{},this._callbacks["$"+s]||[]};b.prototype.hasListeners=function(s){return!!this.listeners(s).length};const Y=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),_=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),Qe="arraybuffer";function Ae(s,...e){return e.reduce((t,i)=>(s.hasOwnProperty(i)&&(t[i]=s[i]),t),{})}const Ze=_.setTimeout,et=_.clearTimeout;function j(s,e){e.useNativeTimers?(s.setTimeoutFn=Ze.bind(_),s.clearTimeoutFn=et.bind(_)):(s.setTimeoutFn=_.setTimeout.bind(_),s.clearTimeoutFn=_.clearTimeout.bind(_))}const tt=1.33;function it(s){return typeof s=="string"?st(s):Math.ceil((s.byteLength||s.size)*tt)}function st(s){let e=0,t=0;for(let i=0,n=s.length;i<n;i++)e=s.charCodeAt(i),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(i++,t+=4);return t}function Ee(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function nt(s){let e="";for(let t in s)s.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(s[t]));return e}function ot(s){let e={},t=s.split("&");for(let i=0,n=t.length;i<n;i++){let o=t[i].split("=");e[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return e}class rt extends Error{constructor(e,t,i){super(e),this.description=t,this.context=i,this.type="TransportError"}}class ce extends b{constructor(e){super(),this.writable=!1,j(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,i){return super.emitReserved("error",new rt(e,t,i)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=le(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port)!==443||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=nt(e);return t.length?"?"+t:""}}class at extends ce{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let i=0;this._polling&&(i++,this.once("pollComplete",function(){--i||t()})),this.writable||(i++,this.once("drain",function(){--i||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=i=>{if(this.readyState==="opening"&&i.type==="open"&&this.onOpen(),i.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(i)};Ye(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,Xe(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=Ee()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let Re=!1;try{Re=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const lt=Re;function ct(){}class ht extends at{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let i=location.port;i||(i=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||i!==e.port}}doWrite(e,t){const i=this.request({method:"POST",data:e});i.on("success",t),i.on("error",(n,o)=>{this.onError("xhr post error",n,o)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,i)=>{this.onError("xhr poll error",t,i)}),this.pollXhr=e}}class z extends b{constructor(e,t,i){super(),this.createRequest=e,j(this,i),this._opts=i,this._method=i.method||"GET",this._uri=t,this._data=i.data!==void 0?i.data:null,this._create()}_create(){var e;const t=Ae(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const i=this._xhr=this.createRequest(t);try{i.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){i.setDisableHeaderCheck&&i.setDisableHeaderCheck(!0);for(let n in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(n)&&i.setRequestHeader(n,this._opts.extraHeaders[n])}}catch{}if(this._method==="POST")try{i.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{i.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(i),"withCredentials"in i&&(i.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(i.timeout=this._opts.requestTimeout),i.onreadystatechange=()=>{var n;i.readyState===3&&((n=this._opts.cookieJar)===null||n===void 0||n.parseCookies(i.getResponseHeader("set-cookie"))),i.readyState===4&&(i.status===200||i.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof i.status=="number"?i.status:0)},0))},i.send(this._data)}catch(n){this.setTimeoutFn(()=>{this._onError(n)},0);return}typeof document<"u"&&(this._index=z.requestsCount++,z.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=ct,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete z.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}z.requestsCount=0;z.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",ye);else if(typeof addEventListener=="function"){const s="onpagehide"in _?"pagehide":"unload";addEventListener(s,ye,!1)}}function ye(){for(let s in z.requests)z.requests.hasOwnProperty(s)&&z.requests[s].abort()}const ut=(function(){const s=xe({xdomain:!1});return s&&s.responseType!==null})();class dt extends ht{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=ut&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new z(xe,this.uri(),e)}}function xe(s){const e=s.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||lt))return new XMLHttpRequest}catch{}if(!e)try{return new _[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Me=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class ft extends ce{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,i=Me?{}:Ae(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(i.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,i)}catch(n){return this.emitReserved("error",n)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const i=e[t],n=t===e.length-1;ae(i,this.supportsBinary,o=>{try{this.doWrite(i,o)}catch{}n&&Y(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=Ee()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const Z=_.WebSocket||_.MozWebSocket;class pt extends ft{createSocket(e,t,i){return Me?new Z(e,t,i):t?new Z(e,t):new Z(e)}doWrite(e,t){this.ws.send(t)}}class mt extends ce{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=Ke(Number.MAX_SAFE_INTEGER,this.socket.binaryType),i=e.readable.pipeThrough(t).getReader(),n=je();n.readable.pipeTo(e.writable),this._writer=n.writable.getWriter();const o=()=>{i.read().then(({done:a,value:c})=>{a||(this.onPacket(c),o())}).catch(a=>{})};o();const r={type:"open"};this.query.sid&&(r.data=`{"sid":"${this.query.sid}"}`),this._writer.write(r).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const i=e[t],n=t===e.length-1;this._writer.write(i).then(()=>{n&&Y(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const gt={websocket:pt,webtransport:mt,polling:dt},yt=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,St=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function te(s){if(s.length>8e3)throw"URI too long";const e=s,t=s.indexOf("["),i=s.indexOf("]");t!=-1&&i!=-1&&(s=s.substring(0,t)+s.substring(t,i).replace(/:/g,";")+s.substring(i,s.length));let n=yt.exec(s||""),o={},r=14;for(;r--;)o[St[r]]=n[r]||"";return t!=-1&&i!=-1&&(o.source=e,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o.pathNames=bt(o,o.path),o.queryKey=vt(o,o.query),o}function bt(s,e){const t=/\/{2,9}/g,i=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&i.splice(0,1),e.slice(-1)=="/"&&i.splice(i.length-1,1),i}function vt(s,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(i,n,o){n&&(t[n]=o)}),t}const ie=typeof addEventListener=="function"&&typeof removeEventListener=="function",U=[];ie&&addEventListener("offline",()=>{U.forEach(s=>s())},!1);class x extends b{constructor(e,t){if(super(),this.binaryType=Qe,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const i=te(e);t.hostname=i.host,t.secure=i.protocol==="https"||i.protocol==="wss",t.port=i.port,i.query&&(t.query=i.query)}else t.host&&(t.hostname=te(t.host).host);j(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(i=>{const n=i.prototype.name;this.transports.push(n),this._transportsByName[n]=i}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=ot(this.opts.query)),ie&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},U.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=ze,t.transport=e,this.id&&(t.sid=this.id);const i=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](i)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&x.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",x.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let i=0;i<this.writeBuffer.length;i++){const n=this.writeBuffer[i].data;if(n&&(t+=it(n)),i>0&&t>this._maxPayload)return this.writeBuffer.slice(0,i);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,Y(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,i){return this._sendPacket("message",e,t,i),this}send(e,t,i){return this._sendPacket("message",e,t,i),this}_sendPacket(e,t,i,n){if(typeof t=="function"&&(n=t,t=void 0),typeof i=="function"&&(n=i,i=null),this.readyState==="closing"||this.readyState==="closed")return;i=i||{},i.compress=i.compress!==!1;const o={type:e,data:t,options:i};this.emitReserved("packetCreate",o),this.writeBuffer.push(o),n&&this.once("flush",n),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},i=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?i():e()}):this.upgrading?i():e()),this}_onError(e){if(x.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),ie&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const i=U.indexOf(this._offlineEventListener);i!==-1&&U.splice(i,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}x.protocol=ze;class Ct extends x{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),i=!1;x.priorWebsocketSuccess=!1;const n=()=>{i||(t.send([{type:"ping",data:"probe"}]),t.once("packet",m=>{if(!i)if(m.type==="pong"&&m.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;x.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{i||this.readyState!=="closed"&&(u(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const v=new Error("probe error");v.transport=t.name,this.emitReserved("upgradeError",v)}}))};function o(){i||(i=!0,u(),t.close(),t=null)}const r=m=>{const v=new Error("probe error: "+m);v.transport=t.name,o(),this.emitReserved("upgradeError",v)};function a(){r("transport closed")}function c(){r("socket closed")}function h(m){t&&m.name!==t.name&&o()}const u=()=>{t.removeListener("open",n),t.removeListener("error",r),t.removeListener("close",a),this.off("close",c),this.off("upgrading",h)};t.once("open",n),t.once("error",r),t.once("close",a),this.once("close",c),this.once("upgrading",h),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{i||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let i=0;i<e.length;i++)~this.transports.indexOf(e[i])&&t.push(e[i]);return t}}let _t=class extends Ct{constructor(e,t={}){const i=typeof e=="object"?e:t;(!i.transports||i.transports&&typeof i.transports[0]=="string")&&(i.transports=(i.transports||["polling","websocket","webtransport"]).map(n=>gt[n]).filter(n=>!!n)),super(e,i)}};function Tt(s,e="",t){let i=s;t=t||typeof location<"u"&&location,s==null&&(s=t.protocol+"//"+t.host),typeof s=="string"&&(s.charAt(0)==="/"&&(s.charAt(1)==="/"?s=t.protocol+s:s=t.host+s),/^(https?|wss?):\/\//.test(s)||(typeof t<"u"?s=t.protocol+"//"+s:s="https://"+s),i=te(s)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const o=i.host.indexOf(":")!==-1?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+o+":"+i.port+e,i.href=i.protocol+"://"+o+(t&&t.port===i.port?"":":"+i.port),i}const kt=typeof ArrayBuffer=="function",wt=s=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(s):s.buffer instanceof ArrayBuffer,Le=Object.prototype.toString,zt=typeof Blob=="function"||typeof Blob<"u"&&Le.call(Blob)==="[object BlobConstructor]",At=typeof File=="function"||typeof File<"u"&&Le.call(File)==="[object FileConstructor]";function he(s){return kt&&(s instanceof ArrayBuffer||wt(s))||zt&&s instanceof Blob||At&&s instanceof File}function F(s,e){if(!s||typeof s!="object")return!1;if(Array.isArray(s)){for(let t=0,i=s.length;t<i;t++)if(F(s[t]))return!0;return!1}if(he(s))return!0;if(s.toJSON&&typeof s.toJSON=="function"&&arguments.length===1)return F(s.toJSON(),!0);for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)&&F(s[t]))return!0;return!1}function Et(s){const e=[],t=s.data,i=s;return i.data=se(t,e),i.attachments=e.length,{packet:i,buffers:e}}function se(s,e){if(!s)return s;if(he(s)){const t={_placeholder:!0,num:e.length};return e.push(s),t}else if(Array.isArray(s)){const t=new Array(s.length);for(let i=0;i<s.length;i++)t[i]=se(s[i],e);return t}else if(typeof s=="object"&&!(s instanceof Date)){const t={};for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=se(s[i],e));return t}return s}function Rt(s,e){return s.data=ne(s.data,e),delete s.attachments,s}function ne(s,e){if(!s)return s;if(s&&s._placeholder===!0){if(typeof s.num=="number"&&s.num>=0&&s.num<e.length)return e[s.num];throw new Error("illegal attachments")}else if(Array.isArray(s))for(let t=0;t<s.length;t++)s[t]=ne(s[t],e);else if(typeof s=="object")for(const t in s)Object.prototype.hasOwnProperty.call(s,t)&&(s[t]=ne(s[t],e));return s}const xt=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var f;(function(s){s[s.CONNECT=0]="CONNECT",s[s.DISCONNECT=1]="DISCONNECT",s[s.EVENT=2]="EVENT",s[s.ACK=3]="ACK",s[s.CONNECT_ERROR=4]="CONNECT_ERROR",s[s.BINARY_EVENT=5]="BINARY_EVENT",s[s.BINARY_ACK=6]="BINARY_ACK"})(f||(f={}));class Mt{constructor(e){this.replacer=e}encode(e){return(e.type===f.EVENT||e.type===f.ACK)&&F(e)?this.encodeAsBinary({type:e.type===f.EVENT?f.BINARY_EVENT:f.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===f.BINARY_EVENT||e.type===f.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Et(e),i=this.encodeAsString(t.packet),n=t.buffers;return n.unshift(i),n}}class ue extends b{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const i=t.type===f.BINARY_EVENT;i||t.type===f.BINARY_ACK?(t.type=i?f.EVENT:f.ACK,this.reconstructor=new Lt(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(he(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const i={type:Number(e.charAt(0))};if(f[i.type]===void 0)throw new Error("unknown packet type "+i.type);if(i.type===f.BINARY_EVENT||i.type===f.BINARY_ACK){const o=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const r=e.substring(o,t);if(r!=Number(r)||e.charAt(t)!=="-")throw new Error("Illegal attachments");i.attachments=Number(r)}if(e.charAt(t+1)==="/"){const o=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););i.nsp=e.substring(o,t)}else i.nsp="/";const n=e.charAt(t+1);if(n!==""&&Number(n)==n){const o=t+1;for(;++t;){const r=e.charAt(t);if(r==null||Number(r)!=r){--t;break}if(t===e.length)break}i.id=Number(e.substring(o,t+1))}if(e.charAt(++t)){const o=this.tryParse(e.substr(t));if(ue.isPayloadValid(i.type,o))i.data=o;else throw new Error("invalid payload")}return i}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case f.CONNECT:return Se(t);case f.DISCONNECT:return t===void 0;case f.CONNECT_ERROR:return typeof t=="string"||Se(t);case f.EVENT:case f.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&xt.indexOf(t[0])===-1);case f.ACK:case f.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Lt{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=Rt(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function Se(s){return Object.prototype.toString.call(s)==="[object Object]"}const Ot=Object.freeze(Object.defineProperty({__proto__:null,Decoder:ue,Encoder:Mt,get PacketType(){return f}},Symbol.toStringTag,{value:"Module"}));function T(s,e,t){return s.on(e,t),function(){s.off(e,t)}}const Bt=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Oe extends b{constructor(e,t,i){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,i&&i.auth&&(this.auth=i.auth),this._opts=Object.assign({},i),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[T(e,"open",this.onopen.bind(this)),T(e,"packet",this.onpacket.bind(this)),T(e,"error",this.onerror.bind(this)),T(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var i,n,o;if(Bt.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const r={type:f.EVENT,data:t};if(r.options={},r.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const u=this.ids++,m=t.pop();this._registerAckCallback(u,m),r.id=u}const a=(n=(i=this.io.engine)===null||i===void 0?void 0:i.transport)===null||n===void 0?void 0:n.writable,c=this.connected&&!(!((o=this.io.engine)===null||o===void 0)&&o._hasPingExpired());return this.flags.volatile&&!a||(c?(this.notifyOutgoingListeners(r),this.packet(r)):this.sendBuffer.push(r)),this.flags={},this}_registerAckCallback(e,t){var i;const n=(i=this.flags.timeout)!==null&&i!==void 0?i:this._opts.ackTimeout;if(n===void 0){this.acks[e]=t;return}const o=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===e&&this.sendBuffer.splice(a,1);t.call(this,new Error("operation has timed out"))},n),r=(...a)=>{this.io.clearTimeoutFn(o),t.apply(this,a)};r.withError=!0,this.acks[e]=r}emitWithAck(e,...t){return new Promise((i,n)=>{const o=(r,a)=>r?n(r):i(a);o.withError=!0,t.push(o),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const i={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((n,...o)=>(this._queue[0],n!==null?i.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(n)):(this._queue.shift(),t&&t(null,...o)),i.pending=!1,this._drainQueue())),this._queue.push(i),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:f.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(i=>String(i.id)===e)){const i=this.acks[e];delete this.acks[e],i.withError&&i.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case f.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case f.EVENT:case f.BINARY_EVENT:this.onevent(e);break;case f.ACK:case f.BINARY_ACK:this.onack(e);break;case f.DISCONNECT:this.ondisconnect();break;case f.CONNECT_ERROR:this.destroy();const i=new Error(e.data.message);i.data=e.data.data,this.emitReserved("connect_error",i);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const i of t)i.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let i=!1;return function(...n){i||(i=!0,t.packet({type:f.ACK,id:e,data:n}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:f.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let i=0;i<t.length;i++)if(e===t[i])return t.splice(i,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let i=0;i<t.length;i++)if(e===t[i])return t.splice(i,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const i of t)i.apply(this,e.data)}}}function P(s){s=s||{},this.ms=s.min||100,this.max=s.max||1e4,this.factor=s.factor||2,this.jitter=s.jitter>0&&s.jitter<=1?s.jitter:0,this.attempts=0}P.prototype.duration=function(){var s=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*s);s=(Math.floor(e*10)&1)==0?s-t:s+t}return Math.min(s,this.max)|0};P.prototype.reset=function(){this.attempts=0};P.prototype.setMin=function(s){this.ms=s};P.prototype.setMax=function(s){this.max=s};P.prototype.setJitter=function(s){this.jitter=s};class oe extends b{constructor(e,t){var i;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,j(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((i=t.randomizationFactor)!==null&&i!==void 0?i:.5),this.backoff=new P({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const n=t.parser||Ot;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new _t(this.uri,this.opts);const t=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;const n=T(t,"open",function(){i.onopen(),e&&e()}),o=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),e?e(a):this.maybeReconnectOnOpen()},r=T(t,"error",o);if(this._timeout!==!1){const a=this._timeout,c=this.setTimeoutFn(()=>{n(),o(new Error("timeout")),t.close()},a);this.opts.autoUnref&&c.unref(),this.subs.push(()=>{this.clearTimeoutFn(c)})}return this.subs.push(n),this.subs.push(r),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(T(e,"ping",this.onping.bind(this)),T(e,"data",this.ondata.bind(this)),T(e,"error",this.onerror.bind(this)),T(e,"close",this.onclose.bind(this)),T(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){Y(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let i=this.nsps[e];return i?this._autoConnect&&!i.active&&i.connect():(i=new Oe(this,e,t),this.nsps[e]=i),i}_destroy(e){const t=Object.keys(this.nsps);for(const i of t)if(this.nsps[i].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let i=0;i<t.length;i++)this.engine.write(t[i],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var i;this.cleanup(),(i=this.engine)===null||i===void 0||i.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const i=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(n=>{n?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",n)):e.onreconnect()}))},t);this.opts.autoUnref&&i.unref(),this.subs.push(()=>{this.clearTimeoutFn(i)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const I={};function G(s,e){typeof s=="object"&&(e=s,s=void 0),e=e||{};const t=Tt(s,e.path||"/socket.io"),i=t.source,n=t.id,o=t.path,r=I[n]&&o in I[n].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||r;let c;return a?c=new oe(i,e):(I[n]||(I[n]=new oe(i,e)),c=I[n]),t.query&&!e.query&&(e.query=t.queryKey),c.socket(t.path,e)}Object.assign(G,{Manager:oe,Socket:Oe,io:G,connect:G});class Pt{constructor(){this.socket=null,this.serverUrl="",this.callbacks=new Map}connect(e){return new Promise((t,i)=>{this.serverUrl=e,this.socket=G(e,{transports:["websocket","polling"],timeout:1e4,reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3}),this.socket.on("connect",()=>{console.log("Подключено к серверу:",e),this.setupListeners(),this.emit("socket_connected",void 0),t()}),this.socket.on("connect_error",n=>{console.error("Ошибка подключения:",n),i(n)}),setTimeout(()=>{this.socket?.connected||i(new Error("Превышено время ожидания подключения"))},1e4)})}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null)}isConnected(){return this.socket?.connected??!1}joinGame(e,t,i){const n={roomId:e,playerName:t,playerId:i};this.socket?.emit("join_game",n)}leaveRoom(){this.socket?.emit("leave_room")}placeShips(e){this.socket?.emit("place_ships",e)}ready(){this.socket?.emit("ready")}shoot(e,t){const i={x:e,y:t};this.socket?.emit("shoot",i)}useScan(e,t){const i={x:e,y:t};this.socket?.emit("use_scan",i)}useScout(e,t){const i={x:e,y:t};this.socket?.emit("use_scout",i)}useFlag(e,t){const i={x:e,y:t};this.socket?.emit("use_flag",i)}moveShip(e,t,i,n){const o={shipId:e,newPosition:{x:t,y:i},newRotation:n};this.socket?.emit("move_ship",o)}on(e,t){this.callbacks.has(e)||this.callbacks.set(e,[]),this.callbacks.get(e).push(t)}off(e,t){if(!t)this.callbacks.delete(e);else{const i=this.callbacks.get(e);if(i){const n=i.indexOf(t);n>-1&&i.splice(n,1)}}}emit(e,t){const i=this.callbacks.get(e);i&&i.forEach(n=>n(t))}setupListeners(){this.socket&&(this.socket.on("room_joined",e=>{this.emit("room_joined",e)}),this.socket.on("opponent_joined",e=>{this.emit("opponent_joined",e)}),this.socket.on("opponent_disconnected",e=>{this.emit("opponent_disconnected",e)}),this.socket.on("opponent_reconnected",e=>{this.emit("opponent_reconnected",e)}),this.socket.on("game_start",e=>{this.emit("game_start",e)}),this.socket.on("turn_result",e=>{this.emit("turn_result",e)}),this.socket.on("scan_result",e=>{this.emit("scan_result",e)}),this.socket.on("scout_result",e=>{this.emit("scout_result",e)}),this.socket.on("scout_sent",e=>{this.emit("scout_sent",e)}),this.socket.on("flag_result",e=>{this.emit("flag_result",e)}),this.socket.on("opponent_action",e=>{this.emit("opponent_action",e)}),this.socket.on("turn_changed",e=>{this.emit("turn_changed",e)}),this.socket.on("timer_update",e=>{this.emit("timer_update",e)}),this.socket.on("game_over",e=>{this.emit("game_over",e)}),this.socket.on("sync_state",e=>{this.emit("sync_state",e)}),this.socket.on("room_closed",e=>{this.emit("room_closed",e)}),this.socket.on("error",e=>{this.emit("error",e)}),this.socket.on("disconnect",e=>{console.log("Отключено от сервера:",e),this.emit("disconnect",{reason:e})}),this.socket.on("reconnect",e=>{console.log("Переподключение, попытка:",e),this.emit("reconnect",{attemptNumber:e})}))}}const d=new Pt,p={BOARD_SIZE:10,SHIPS:[{size:4,count:1},{size:3,count:2},{size:2,count:3},{size:1,count:4}],MINES_COUNT:9,MAX_ARMOR:5,MAX_LIVES:3,MAX_SCOUTS:10,SCAN_COOLDOWN:5,SCOUT_COOLDOWN:5,TURN_TIME:60};class It{constructor(e,t,i){this.cellSize=45,this.boardSize=p.BOARD_SIZE,this.labelOffset=25,this.ships=[],this.mines=[],this.armor=new Map,this.shipTemplates=[],this.selectedShipSize=0,this.currentRotation="horizontal",this.hoverPosition=null,this.placementMode="ship",this.canvas=e,this.ctx=e.getContext("2d"),this.shipsContainer=t,this.callbacks=i}initialize(){this.shipTemplates=p.SHIPS.map(e=>({size:e.size,count:e.count,placed:0})),this.renderShipsList(),this.setupEventListeners(),this.render()}renderShipsList(){this.shipsContainer.innerHTML="",this.shipTemplates.forEach((t,i)=>{t.count-t.placed;for(let n=0;n<t.count;n++){const o=document.createElement("div");o.className=`ship-item${n<t.placed?" placed":""}`,o.dataset.size=String(t.size),o.dataset.index=String(i);const r=document.createElement("div");r.className="ship-preview";for(let c=0;c<t.size;c++){const h=document.createElement("div");h.className="ship-cell",r.appendChild(h)}const a=document.createElement("span");a.textContent=`${t.size}-палубный`,o.appendChild(r),o.appendChild(a),n>=t.placed&&o.addEventListener("click",()=>this.selectShip(t.size)),this.shipsContainer.appendChild(o)}});const e=document.createElement("div");e.className="placement-modes",e.style.marginTop="20px",e.innerHTML=`
      <button class="btn btn-small ${this.placementMode==="mine"?"active":""}" id="mode-mine">
        Ставить мины
      </button>
      <button class="btn btn-small ${this.placementMode==="armor"?"active":""}" id="mode-armor">
        Ставить броню
      </button>
    `,this.shipsContainer.appendChild(e),document.getElementById("mode-mine")?.addEventListener("click",()=>{this.placementMode="mine",this.selectedShipSize=0,this.updateModeButtons(),this.render()}),document.getElementById("mode-armor")?.addEventListener("click",()=>{this.placementMode="armor",this.selectedShipSize=0,this.updateModeButtons(),this.render()})}updateModeButtons(){document.querySelectorAll(".ship-item").forEach(i=>{i.classList.remove("selected"),this.selectedShipSize>0&&i.getAttribute("data-size")===String(this.selectedShipSize)&&i.classList.add("selected")});const e=document.getElementById("mode-mine"),t=document.getElementById("mode-armor");e&&(e.className=`btn btn-small ${this.placementMode==="mine"?"active":""}`),t&&(t.className=`btn btn-small ${this.placementMode==="armor"?"active":""}`)}selectShip(e){this.selectedShipSize=e,this.placementMode="ship",this.updateModeButtons(),this.render()}setupEventListeners(){this.canvas.addEventListener("mousemove",e=>this.onMouseMove(e)),this.canvas.addEventListener("click",e=>this.onClick(e)),this.canvas.addEventListener("contextmenu",e=>{e.preventDefault(),this.onRightClick(e)}),this.canvas.addEventListener("mouseleave",()=>{this.hoverPosition=null,this.render()})}getGridPosition(e){const t=this.canvas.getBoundingClientRect(),i=Math.floor((e.clientX-t.left-this.labelOffset)/this.cellSize),n=Math.floor((e.clientY-t.top-this.labelOffset)/this.cellSize);return i>=0&&i<this.boardSize&&n>=0&&n<this.boardSize?{x:i,y:n}:null}onMouseMove(e){this.hoverPosition=this.getGridPosition(e),this.render()}onClick(e){const t=this.getGridPosition(e);t&&(this.placementMode==="ship"&&this.selectedShipSize>0?this.placeShip(t):this.placementMode==="mine"?this.placeMine(t):this.placementMode==="armor"&&this.placeArmor(t))}onRightClick(e){const t=this.getGridPosition(e);t&&this.removeAt(t)}placeShip(e){if(!this.canPlaceShip(e,this.selectedShipSize,this.currentRotation))return;const t=this.shipTemplates.find(o=>o.size===this.selectedShipSize&&o.placed<o.count);if(!t)return;const i={id:`ship-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,size:this.selectedShipSize,position:e,rotation:this.currentRotation,hits:[],armorSegment:null,armorBroken:!1};this.ships.push(i),t.placed++;const n=this.shipTemplates.find(o=>o.placed<o.count);n?this.selectedShipSize=n.size:(this.selectedShipSize=0,this.mines.length<p.MINES_COUNT&&(this.placementMode="mine")),this.renderShipsList(),this.callbacks.onShipsChanged(),this.render()}placeMine(e){this.mines.length>=p.MINES_COUNT||this.isOccupied(e)||this.mines.some(t=>t.x===e.x&&t.y===e.y)||(this.mines.push(e),this.callbacks.onMinesChanged(this.mines.length),this.render())}placeArmor(e){if(this.armor.size>=p.MAX_ARMOR)return;const t=this.getShipAt(e);if(!t||this.armor.has(t.id))return;const i=this.getSegmentAt(t,e);i!==-1&&(this.armor.set(t.id,i),t.armorSegment=i,this.callbacks.onArmorChanged(this.armor.size),this.render())}getSegmentAt(e,t){return this.getShipCells(e.position,e.size,e.rotation).findIndex(n=>n.x===t.x&&n.y===t.y)}removeAt(e){const t=this.mines.findIndex(o=>o.x===e.x&&o.y===e.y);if(t>=0){this.mines.splice(t,1),this.callbacks.onMinesChanged(this.mines.length),this.render();return}const i=this.getShipAt(e);if(i&&this.armor.has(i.id)){const o=this.armor.get(i.id);if(this.getSegmentAt(i,e)===o){this.armor.delete(i.id),i.armorSegment=null,this.callbacks.onArmorChanged(this.armor.size),this.render();return}}const n=this.ships.findIndex(o=>this.isShipAt(o,e));if(n>=0){const o=this.ships[n],r=this.shipTemplates.find(a=>a.size===o.size);r&&r.placed--,this.armor.delete(o.id),this.callbacks.onArmorChanged(this.armor.size),this.ships.splice(n,1),this.renderShipsList(),this.callbacks.onShipsChanged(),this.render()}}canPlaceShip(e,t,i){const n=this.getShipCells(e,t,i);for(const o of n)if(o.x<0||o.x>=this.boardSize||o.y<0||o.y>=this.boardSize)return!1;for(const o of n)for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){const c=o.x+r,h=o.y+a;if(c>=0&&c<this.boardSize&&h>=0&&h<this.boardSize&&this.isOccupiedByShip({x:c,y:h}))return!1}return!0}getShipCells(e,t,i){const n=[];for(let o=0;o<t;o++)i==="horizontal"?n.push({x:e.x+o,y:e.y}):n.push({x:e.x,y:e.y+o});return n}isOccupied(e){return this.isOccupiedByShip(e)||this.mines.some(t=>t.x===e.x&&t.y===e.y)}isOccupiedByShip(e){return this.ships.some(t=>this.isShipAt(t,e))}isShipAt(e,t){return this.getShipCells(e.position,e.size,e.rotation).some(n=>n.x===t.x&&n.y===t.y)}getShipAt(e){return this.ships.find(t=>this.isShipAt(t,e))||null}rotateSelectedShip(){this.currentRotation=this.currentRotation==="horizontal"?"vertical":"horizontal",this.render()}clearBoard(){this.ships=[],this.mines=[],this.armor=new Map,this.shipTemplates.forEach(e=>e.placed=0),this.selectedShipSize=this.shipTemplates[0].size,this.placementMode="ship",this.renderShipsList(),this.callbacks.onShipsChanged(),this.callbacks.onMinesChanged(0),this.callbacks.onArmorChanged(0),this.render()}randomPlacement(){this.clearBoard();for(const t of this.shipTemplates)for(let i=0;i<t.count;i++){let n=!1,o=0;for(;!n&&o<1e3;){const r=Math.random()>.5?"horizontal":"vertical",a=r==="horizontal"?this.boardSize-t.size:this.boardSize-1,c=r==="vertical"?this.boardSize-t.size:this.boardSize-1,h={x:Math.floor(Math.random()*(a+1)),y:Math.floor(Math.random()*(c+1))};if(this.canPlaceShip(h,t.size,r)){const u={id:`ship-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,size:t.size,position:h,rotation:r,hits:[],armorSegment:null,armorBroken:!1};this.ships.push(u),t.placed++,n=!0}o++}}for(;this.mines.length<p.MINES_COUNT;){const t={x:Math.floor(Math.random()*this.boardSize),y:Math.floor(Math.random()*this.boardSize)};this.isOccupied(t)||this.mines.push(t)}const e=this.ships.map(t=>t.id);for(;this.armor.size<p.MAX_ARMOR&&e.length>0;){const t=Math.floor(Math.random()*e.length),i=e.splice(t,1)[0],n=this.ships.find(o=>o.id===i);if(n){const o=Math.floor(Math.random()*n.size);this.armor.set(i,o),n.armorSegment=o}}this.selectedShipSize=0,this.placementMode="ship",this.renderShipsList(),this.callbacks.onShipsChanged(),this.callbacks.onMinesChanged(this.mines.length),this.callbacks.onArmorChanged(this.armor.size),this.render()}isPlacementComplete(){const e=this.shipTemplates.every(i=>i.placed===i.count),t=this.mines.length===p.MINES_COUNT;return e&&t}getPlacementData(){return{ships:this.ships.map(e=>({...e,armorSegment:this.armor.get(e.id)??null})),mines:[...this.mines],armor:Array.from(this.armor.entries()).map(([e,t])=>({shipId:e,segment:t}))}}setPlacementData(e){this.ships=e.ships.map(t=>({...t})),this.mines=[...e.mines],this.armor=new Map(e.armor.map(t=>[t.shipId,t.segment])),this.shipTemplates.forEach(t=>{t.placed=this.ships.filter(i=>i.size===t.size).length}),this.selectedShipSize=0,this.placementMode="ship",this.renderShipsList(),this.callbacks.onShipsChanged(),this.callbacks.onMinesChanged(this.mines.length),this.callbacks.onArmorChanged(this.armor.size),this.render()}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawGrid(),this.drawShips(),this.drawMines(),this.hoverPosition&&this.drawPreview()}drawGrid(){const e=this.labelOffset;this.ctx.strokeStyle="#2a3f5f",this.ctx.lineWidth=1;for(let t=0;t<=this.boardSize;t++)this.ctx.beginPath(),this.ctx.moveTo(e+t*this.cellSize,e),this.ctx.lineTo(e+t*this.cellSize,e+this.boardSize*this.cellSize),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(e,e+t*this.cellSize),this.ctx.lineTo(e+this.boardSize*this.cellSize,e+t*this.cellSize),this.ctx.stroke();this.ctx.fillStyle="#8899aa",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle";for(let t=0;t<this.boardSize;t++)this.ctx.fillText(String.fromCharCode(65+t),e+t*this.cellSize+this.cellSize/2,e/2),this.ctx.fillText(String(t+1),e/2,e+t*this.cellSize+this.cellSize/2)}drawShips(){const e=this.labelOffset;for(const t of this.ships){const i=this.getShipCells(t.position,t.size,t.rotation),n=this.armor.get(t.id),o=n!==void 0;for(let r=0;r<i.length;r++){const a=i[r],c=n===r;this.ctx.fillStyle=c?"#ffd700":"#3282b8",this.ctx.fillRect(e+a.x*this.cellSize+2,e+a.y*this.cellSize+2,this.cellSize-4,this.cellSize-4)}this.ctx.strokeStyle=o?"#ffaa00":"#00d9ff",this.ctx.lineWidth=2,this.ctx.strokeRect(e+i[0].x*this.cellSize+2,e+i[0].y*this.cellSize+2,(t.rotation==="horizontal"?t.size*this.cellSize:this.cellSize)-4,(t.rotation==="vertical"?t.size*this.cellSize:this.cellSize)-4)}}drawMines(){const e=this.labelOffset;this.ctx.fillStyle="#ff4757";for(const t of this.mines){this.ctx.beginPath(),this.ctx.arc(e+t.x*this.cellSize+this.cellSize/2,e+t.y*this.cellSize+this.cellSize/2,this.cellSize/3,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#ff4757",this.ctx.lineWidth=2;for(let i=0;i<8;i++){const n=i/8*Math.PI*2,o=e+t.x*this.cellSize+this.cellSize/2,r=e+t.y*this.cellSize+this.cellSize/2;this.ctx.beginPath(),this.ctx.moveTo(o+Math.cos(n)*(this.cellSize/3),r+Math.sin(n)*(this.cellSize/3)),this.ctx.lineTo(o+Math.cos(n)*(this.cellSize/2.2),r+Math.sin(n)*(this.cellSize/2.2)),this.ctx.stroke()}}}drawPreview(){if(!this.hoverPosition)return;const e=this.labelOffset;if(this.placementMode==="ship"&&this.selectedShipSize>0){const t=this.canPlaceShip(this.hoverPosition,this.selectedShipSize,this.currentRotation),i=this.getShipCells(this.hoverPosition,this.selectedShipSize,this.currentRotation);this.ctx.fillStyle=t?"rgba(0, 255, 136, 0.3)":"rgba(255, 71, 87, 0.3)",this.ctx.strokeStyle=t?"#00ff88":"#ff4757",this.ctx.lineWidth=2;for(const n of i)n.x>=0&&n.x<this.boardSize&&n.y>=0&&n.y<this.boardSize&&this.ctx.fillRect(e+n.x*this.cellSize+2,e+n.y*this.cellSize+2,this.cellSize-4,this.cellSize-4)}else if(this.placementMode==="mine"){const t=!this.isOccupied(this.hoverPosition)&&this.mines.length<p.MINES_COUNT;this.ctx.fillStyle=t?"rgba(255, 71, 87, 0.3)":"rgba(255, 71, 87, 0.1)",this.ctx.beginPath(),this.ctx.arc(e+this.hoverPosition.x*this.cellSize+this.cellSize/2,e+this.hoverPosition.y*this.cellSize+this.cellSize/2,this.cellSize/3,0,Math.PI*2),this.ctx.fill()}else if(this.placementMode==="armor"){const t=this.getShipAt(this.hoverPosition),i=t&&!this.armor.has(t.id)&&this.armor.size<p.MAX_ARMOR;t&&(this.ctx.fillStyle=i?"rgba(255, 215, 0, 0.5)":"rgba(255, 215, 0, 0.1)",this.ctx.fillRect(e+this.hoverPosition.x*this.cellSize+2,e+this.hoverPosition.y*this.cellSize+2,this.cellSize-4,this.cellSize-4),i&&(this.ctx.strokeStyle="#ffd700",this.ctx.lineWidth=3,this.ctx.strokeRect(e+this.hoverPosition.x*this.cellSize+2,e+this.hoverPosition.y*this.cellSize+2,this.cellSize-4,this.cellSize-4)))}}}class Nt{constructor(){this.audioContext=null,this.enabled=!0,this.volume=.5,this.masterGain=null}init(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioContext.createGain(),this.masterGain.gain.value=this.volume,this.masterGain.connect(this.audioContext.destination))}setEnabled(e){this.enabled=e}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.masterGain&&(this.masterGain.gain.value=this.volume)}getDestination(){return this.masterGain||this.audioContext.destination}play(e){if(this.enabled&&(this.audioContext||this.init(),!!this.audioContext))switch(this.audioContext.state==="suspended"&&this.audioContext.resume(),e){case"hit":this.playHit();break;case"miss":this.playMiss();break;case"mine":this.playMineExplosion();break;case"sunk":this.playSunk();break;case"scan":this.playScan();break;case"scout":this.playScout();break;case"turn":this.playTurn();break;case"gameStart":this.playGameStart();break;case"gameOver":this.playGameOver();break;case"click":this.playClick();break}}createNoise(e){const t=this.audioContext,i=t.sampleRate*e,n=t.createBuffer(1,i,t.sampleRate),o=n.getChannelData(0);for(let a=0;a<i;a++)o[a]=Math.random()*2-1;const r=t.createBufferSource();return r.buffer=n,r}playHit(){const e=this.audioContext,t=e.currentTime,i=e.createOscillator(),n=e.createOscillator(),o=e.createGain(),r=e.createBiquadFilter();r.type="bandpass",r.frequency.value=800,r.Q.value=2,i.type="square",i.frequency.setValueAtTime(300,t),i.frequency.exponentialRampToValueAtTime(150,t+.1),n.type="sawtooth",n.frequency.setValueAtTime(600,t),n.frequency.exponentialRampToValueAtTime(200,t+.08),o.gain.setValueAtTime(.5,t),o.gain.exponentialRampToValueAtTime(.001,t+.2),i.connect(r),n.connect(r),r.connect(o),o.connect(this.getDestination()),i.start(t),n.start(t),i.stop(t+.2),n.stop(t+.2);const a=this.createNoise(.1),c=e.createGain(),h=e.createBiquadFilter();h.type="highpass",h.frequency.value=1e3,c.gain.setValueAtTime(.3,t),c.gain.exponentialRampToValueAtTime(.001,t+.1),a.connect(h),h.connect(c),c.connect(this.getDestination()),a.start(t),a.stop(t+.1)}playMiss(){const e=this.audioContext,t=e.currentTime,i=this.createNoise(.4),n=e.createBiquadFilter(),o=e.createGain();n.type="bandpass",n.frequency.setValueAtTime(1200,t),n.frequency.exponentialRampToValueAtTime(400,t+.15),n.Q.value=1,o.gain.setValueAtTime(.4,t),o.gain.exponentialRampToValueAtTime(.15,t+.05),o.gain.exponentialRampToValueAtTime(.001,t+.4),i.connect(n),n.connect(o),o.connect(this.getDestination()),i.start(t),i.stop(t+.4);const r=e.createOscillator(),a=e.createGain();r.type="sine",r.frequency.setValueAtTime(150,t+.02),r.frequency.exponentialRampToValueAtTime(80,t+.15),a.gain.setValueAtTime(.3,t+.02),a.gain.exponentialRampToValueAtTime(.001,t+.2),r.connect(a),a.connect(this.getDestination()),r.start(t+.02),r.stop(t+.2)}playMineExplosion(){const e=this.audioContext,t=e.currentTime,i=e.createOscillator(),n=e.createGain();i.type="sine",i.frequency.setValueAtTime(100,t),i.frequency.exponentialRampToValueAtTime(20,t+.5),n.gain.setValueAtTime(.8,t),n.gain.exponentialRampToValueAtTime(.001,t+.6),i.connect(n),n.connect(this.getDestination()),i.start(t),i.stop(t+.6);const o=this.createNoise(.8),r=e.createBiquadFilter(),a=e.createGain();r.type="lowpass",r.frequency.setValueAtTime(3e3,t),r.frequency.exponentialRampToValueAtTime(200,t+.5),a.gain.setValueAtTime(.7,t),a.gain.exponentialRampToValueAtTime(.001,t+.8),o.connect(r),r.connect(a),a.connect(this.getDestination()),o.start(t),o.stop(t+.8);for(let c=0;c<3;c++){const h=.1+c*.1,u=this.createNoise(.3),m=e.createBiquadFilter(),v=e.createGain();m.type="bandpass",m.frequency.value=500+c*200,m.Q.value=1,v.gain.setValueAtTime(0,t+h),v.gain.linearRampToValueAtTime(.2-c*.05,t+h+.02),v.gain.exponentialRampToValueAtTime(.001,t+h+.3),u.connect(m),m.connect(v),v.connect(this.getDestination()),u.start(t+h),u.stop(t+h+.3)}}playSunk(){const e=this.audioContext,t=e.currentTime,i=this.createNoise(1),n=e.createBiquadFilter(),o=e.createGain();n.type="bandpass",n.frequency.setValueAtTime(400,t),n.frequency.exponentialRampToValueAtTime(150,t+.8),n.Q.value=5,o.gain.setValueAtTime(.4,t),o.gain.linearRampToValueAtTime(.2,t+.5),o.gain.exponentialRampToValueAtTime(.001,t+1),i.connect(n),n.connect(o),o.connect(this.getDestination()),i.start(t),i.stop(t+1);const r=e.createOscillator(),a=e.createGain();r.type="sine",r.frequency.setValueAtTime(200,t),r.frequency.exponentialRampToValueAtTime(50,t+1.2),a.gain.setValueAtTime(.4,t),a.gain.exponentialRampToValueAtTime(.001,t+1.2),r.connect(a),a.connect(this.getDestination()),r.start(t),r.stop(t+1.2);for(let c=0;c<8;c++){const h=.2+Math.random()*.8;setTimeout(()=>this.playBubble(),h*1e3)}}playBubble(){if(!this.audioContext)return;const e=this.audioContext,t=e.currentTime,i=e.createOscillator(),n=e.createGain(),o=600+Math.random()*600;i.type="sine",i.frequency.setValueAtTime(o,t),i.frequency.exponentialRampToValueAtTime(o*1.8,t+.08),n.gain.setValueAtTime(.15,t),n.gain.exponentialRampToValueAtTime(.001,t+.1),i.connect(n),n.connect(this.getDestination()),i.start(t),i.stop(t+.1)}playScan(){const e=this.audioContext,t=e.currentTime,i=e.createOscillator(),n=e.createGain(),o=e.createBiquadFilter();o.type="bandpass",o.frequency.value=1500,o.Q.value=10,i.type="sine",i.frequency.setValueAtTime(800,t),i.frequency.exponentialRampToValueAtTime(2e3,t+.3),i.frequency.exponentialRampToValueAtTime(800,t+.6),n.gain.setValueAtTime(.2,t),n.gain.linearRampToValueAtTime(.3,t+.3),n.gain.exponentialRampToValueAtTime(.001,t+.7),i.connect(o),o.connect(n),n.connect(this.getDestination()),i.start(t),i.stop(t+.7);const r=this.createNoise(.5),a=e.createBiquadFilter(),c=e.createGain();a.type="highpass",a.frequency.value=2e3,c.gain.setValueAtTime(.05,t),c.gain.exponentialRampToValueAtTime(.001,t+.5),r.connect(a),a.connect(c),c.connect(this.getDestination()),r.start(t),r.stop(t+.5)}playScout(){const e=this.audioContext,t=e.currentTime,i=e.createOscillator(),n=e.createGain();i.type="sine",i.frequency.setValueAtTime(1200,t),n.gain.setValueAtTime(.3,t),n.gain.exponentialRampToValueAtTime(.001,t+.5),i.connect(n),n.connect(this.getDestination()),i.start(t),i.stop(t+.5);const o=e.createOscillator(),r=e.createGain();o.type="sine",o.frequency.setValueAtTime(1200,t+.15),r.gain.setValueAtTime(.1,t+.15),r.gain.exponentialRampToValueAtTime(.001,t+.5),o.connect(r),r.connect(this.getDestination()),o.start(t+.15),o.stop(t+.5)}playTurn(){const e=this.audioContext,t=e.currentTime,i=e.createOscillator(),n=e.createOscillator(),o=e.createGain();i.type="sine",i.frequency.value=523,n.type="sine",n.frequency.value=659,o.gain.setValueAtTime(.2,t),o.gain.setValueAtTime(.2,t+.15),o.gain.exponentialRampToValueAtTime(.001,t+.3),i.connect(o),n.connect(o),o.connect(this.getDestination()),i.start(t),i.stop(t+.15),n.start(t+.1),n.stop(t+.3)}playGameStart(){const e=this.audioContext,t=e.currentTime;[{freq:392,time:0},{freq:523,time:.1},{freq:659,time:.2},{freq:784,time:.3}].forEach(n=>{const o=e.createOscillator(),r=e.createGain();o.type="sine",o.frequency.value=n.freq,r.gain.setValueAtTime(0,t+n.time),r.gain.linearRampToValueAtTime(.25,t+n.time+.03),r.gain.exponentialRampToValueAtTime(.001,t+n.time+.2),o.connect(r),r.connect(this.getDestination()),o.start(t+n.time),o.stop(t+n.time+.25)})}playGameOver(){const e=this.audioContext,t=e.currentTime;[{freq:523,time:0},{freq:440,time:.2},{freq:349,time:.4},{freq:262,time:.6}].forEach(n=>{const o=e.createOscillator(),r=e.createGain();o.type="triangle",o.frequency.value=n.freq,r.gain.setValueAtTime(0,t+n.time),r.gain.linearRampToValueAtTime(.3,t+n.time+.05),r.gain.exponentialRampToValueAtTime(.001,t+n.time+.4),o.connect(r),r.connect(this.getDestination()),o.start(t+n.time),o.stop(t+n.time+.5)})}playClick(){const e=this.audioContext,t=e.currentTime,i=e.createOscillator(),n=e.createGain();i.type="sine",i.frequency.value=1e3,n.gain.setValueAtTime(.1,t),n.gain.exponentialRampToValueAtTime(.001,t+.05),i.connect(n),n.connect(this.getDestination()),i.start(t),i.stop(t+.05)}}const y=new Nt;class Be{constructor(e,t,i){this.cellSize=36,this.boardSize=p.BOARD_SIZE,this.labelOffset=25,this.myBoard=null,this.opponentCells=[],this.myCells=[],this.isMyTurn=!1,this.abilityMode="none",this.hoverPosition=null,this.scanCooldown=0,this.scoutCount=p.MAX_SCOUTS,this.scoutCooldown=0,this.myLives=p.MAX_LIVES,this.opponentLives=p.MAX_LIVES,this.turnTimeLeft=p.TURN_TIME,this.gameTime=0,this.gameTimeInterval=null,this.scanAnimations=[],this.activeScanZones=[],this.selfCanvas=e,this.opponentCanvas=t,this.selfCtx=e.getContext("2d"),this.opponentCtx=t.getContext("2d"),this.callbacks=i,this.isMyTurn=i.isMyTurn}initialize(){y.init(),y.play("gameStart"),this.initializeCells(),this.setupEventListeners(),this.startGameTimer(),this.render(),this.callbacks.onAbilityUpdate(this.scanCooldown,this.scoutCount,this.scoutCooldown),this.callbacks.onAbilityModeChange?.(this.abilityMode)}initializeCells(){for(let e=0;e<this.boardSize;e++){this.opponentCells[e]=[],this.myCells[e]=[];for(let t=0;t<this.boardSize;t++)this.opponentCells[e][t]={revealed:!1,hit:!1,armorHit:!1,miss:!1,mine:!1,sunk:!1,scanned:!1,scouted:!1,scoutPending:!1,adjacentCount:0},this.myCells[e][t]={revealed:!1,hit:!1,armorHit:!1,miss:!1,mine:!1,sunk:!1,scanned:!1,scouted:!1,scoutPending:!1,adjacentCount:0}}}setMyBoard(e){this.myBoard={cells:[],ships:e.ships,mines:e.mines};for(const t of e.ships){const i=this.getShipCells(t);for(let n=0;n<i.length;n++){const o=i[n];this.myCells[o.y]&&this.myCells[o.y][o.x]&&(this.myCells[o.y][o.x].shipId=t.id)}}}getShipCells(e){const t=[];for(let i=0;i<e.size;i++)e.rotation==="horizontal"?t.push({x:e.position.x+i,y:e.position.y}):t.push({x:e.position.x,y:e.position.y+i});return t}setupEventListeners(){this.opponentCanvas.addEventListener("mousemove",e=>{this.hoverPosition=this.getGridPosition(e,this.opponentCanvas),this.updateOpponentCursor(),this.render()}),this.opponentCanvas.addEventListener("click",e=>{if(!this.isMyTurn)return;const t=this.getGridPosition(e,this.opponentCanvas);!t||this.opponentCells[t.y][t.x].revealed||(this.abilityMode==="scan"?(this.callbacks.onScan(t.x,t.y),this.setAbilityMode("none")):this.abilityMode==="scout"?(this.callbacks.onScout(t.x,t.y),this.setAbilityMode("none")):this.abilityMode==="flag"?(this.callbacks.onFlag(t.x,t.y),this.setAbilityMode("none")):this.callbacks.onShoot(t.x,t.y))}),this.opponentCanvas.addEventListener("mouseleave",()=>{this.hoverPosition=null,this.updateOpponentCursor(),this.render()})}updateOpponentCursor(){if(!this.isMyTurn){this.opponentCanvas.style.cursor="not-allowed";return}if(!this.hoverPosition){this.opponentCanvas.style.cursor="crosshair";return}const{x:e,y:t}=this.hoverPosition;if(e<0||e>=this.boardSize||t<0||t>=this.boardSize){this.opponentCanvas.style.cursor="crosshair";return}if(this.opponentCells[t][e].revealed){this.opponentCanvas.style.cursor="not-allowed";return}this.opponentCanvas.style.cursor="crosshair"}getGridPosition(e,t){const i=t.getBoundingClientRect(),n=Math.floor((e.clientX-i.left-this.labelOffset)/this.cellSize),o=Math.floor((e.clientY-i.top-this.labelOffset)/this.cellSize);return n>=0&&n<this.boardSize&&o>=0&&o<this.boardSize?{x:n,y:o}:null}setAbilityMode(e){e==="scan"&&this.scanCooldown>0||e==="scout"&&(this.scoutCount<=0||this.scoutCooldown>0)||(this.abilityMode=this.abilityMode===e?"none":e,this.callbacks.onAbilityModeChange?.(this.abilityMode),this.render())}handleTurnResult(e){const t=this.opponentCells[e.y][e.x];if(t.adjacentCount=e.adjacentCount,e.armorHit){t.armorHit=!0,t.revealed=!1,t.hit=!1,t.miss=!1,t.mine=!1,t.sunk=!1,this.callbacks.onLog(`Попадание в броню! [${this.coordToString(e.x,e.y)}]`,"hit"),y.play("hit"),this.render();return}if(t.armorHit=!1,t.revealed=!0,e.hit){if(t.hit=!0,this.callbacks.onLog(`Попадание! [${this.coordToString(e.x,e.y)}]`,"hit"),y.play("hit"),e.sunk&&e.sunkShip){t.sunk=!0;const i=this.getShipCells(e.sunkShip);for(const n of i)this.opponentCells[n.y][n.x].sunk=!0;this.callbacks.onLog(`Корабль потоплен! (${e.sunkShip.size}-палубный)`,"sunk"),y.play("sunk")}}else e.mineHit?(t.mine=!0,this.myLives--,this.callbacks.onLivesChange(this.myLives,this.opponentLives),this.callbacks.onLog(`Мина! Вы потеряли жизнь. [${this.coordToString(e.x,e.y)}]`,"mine"),y.play("mine")):(t.miss=!0,this.callbacks.onLog(`Промах [${this.coordToString(e.x,e.y)}]`,"miss"),y.play("miss"));e.gameOver&&y.play("gameOver"),this.render()}handleScanResult(e){this.scanAnimations.push({x:e.x,y:e.y,hasShips:e.hasShips,phase:"scanning",progress:0,alpha:1,startTime:performance.now()}),this.scanCooldown=p.SCAN_COOLDOWN,this.callbacks.onAbilityUpdate(this.scanCooldown,this.scoutCount,this.scoutCooldown);const t=e.hasShips?"Обнаружены корабли!":"Чисто";this.callbacks.onLog(`Скан [${this.coordToString(e.x,e.y)}]: ${t}`,"info"),y.play("scan"),this.animateScan(),this.render()}handleScoutSent(e){const t=this.opponentCells[e.y][e.x];t.scoutPending=!0,this.scoutCount--,this.scoutCooldown=p.SCOUT_COOLDOWN,this.callbacks.onAbilityUpdate(this.scanCooldown,this.scoutCount,this.scoutCooldown),this.callbacks.onLog(`Разведчик отправлен [${this.coordToString(e.x,e.y)}]. Результат на следующем ходу.`,"info"),y.play("scout"),this.render()}handleFlagResult(e){if(this.myLives=e.lives,this.callbacks.onLivesChange(this.myLives,this.opponentLives),e.success){const t=e.lifeGained?" Бонус: +1 жизнь.":"";this.callbacks.onLog(`Флаг успешен! Мина обезврежена [${this.coordToString(e.x,e.y)}].${t}`,"info"),y.play("scout")}else e.wasShip?this.callbacks.onLog(`Флаг сорван: в секторе был корабль [${this.coordToString(e.x,e.y)}].`,"miss"):this.callbacks.onLog(`Флаг не дал результата [${this.coordToString(e.x,e.y)}].`,"miss");this.render()}handleScoutResult(e){const t=this.opponentCells[e.y][e.x];t.scouted=!0,t.scoutPending=!1,t.adjacentCount=e.cellInfo.adjacentCount;let i="";e.cellInfo.hasShip?i="Корабль!":e.cellInfo.hasMine?i="Мина!":i=`Пусто (${e.cellInfo.adjacentCount} рядом)`,this.callbacks.onLog(`Разведчик вернулся [${this.coordToString(e.x,e.y)}]: ${i}`,"info"),y.play("scout"),this.render()}handleOpponentAction(e){if(e.action==="shoot"&&e.result){const t=this.myCells[e.position.y][e.position.x];t.revealed=!0,e.result.armorHit?(t.armorHit=!0,t.hit=!1,t.miss=!1,t.mine=!1,t.sunk=!1,this.callbacks.onLog(`Противник пробил броню [${this.coordToString(e.position.x,e.position.y)}]`,"hit"),y.play("hit")):e.result.hit?(t.armorHit=!1,t.hit=!0,this.callbacks.onLog(`Противник попал [${this.coordToString(e.position.x,e.position.y)}]`,"hit"),y.play("hit")):e.result.mineHit?(t.armorHit=!1,t.mine=!0,this.opponentLives--,this.callbacks.onLivesChange(this.myLives,this.opponentLives),this.callbacks.onLog("Противник попал в мину!","mine"),y.play("mine")):(t.armorHit=!1,t.miss=!0,this.callbacks.onLog(`Противник промахнулся [${this.coordToString(e.position.x,e.position.y)}]`,"miss"),y.play("miss"))}else e.action==="flag"&&this.callbacks.onLog(`Попытка разминирования в секторе ${this.coordToString(e.position.x,e.position.y)}`,"info");this.render()}handleTurnChanged(e){this.isMyTurn=e.yourTurn,this.turnTimeLeft=p.TURN_TIME,this.updateOpponentCursor(),e.yourTurn&&(this.activeScanZones=[],this.scanCooldown>0&&this.scanCooldown--,this.scoutCooldown>0&&this.scoutCooldown--,this.callbacks.onAbilityUpdate(this.scanCooldown,this.scoutCount,this.scoutCooldown),y.play("turn")),this.callbacks.onTurnChange(e.yourTurn),this.render()}handleTimerUpdate(e){this.turnTimeLeft=e.turnTimeLeft,this.gameTime=e.gameTimeElapsed}applySyncState(e,t,i,n){const o=e.players.find(a=>a?.id===n),r=e.players.find(a=>a?.id!==n);this.turnTimeLeft=e.turnTimeLeft,this.gameTime=e.gameTimeElapsed,this.isMyTurn=e.currentTurn===e.players.findIndex(a=>a?.id===n),this.updateOpponentCursor(),o&&(this.myLives=o.lives,this.scoutCount=o.scoutsRemaining,this.scanCooldown=Math.max(0,p.SCAN_COOLDOWN-(e.turnNumber-o.lastScanTurn)),this.scoutCooldown=Math.max(0,p.SCOUT_COOLDOWN-(e.turnNumber-o.lastScoutTurn))),r&&(this.opponentLives=r.lives),this.callbacks.onLivesChange(this.myLives,this.opponentLives),this.callbacks.onAbilityUpdate(this.scanCooldown,this.scoutCount,this.scoutCooldown),this.myBoard=t,this.initializeCells(),this.applyMyBoardState(t),this.applyOpponentBoardState(i),this.render()}getIsMyTurn(){return this.isMyTurn}getGameTime(){return this.gameTime}startGameTimer(){this.gameTimeInterval=window.setInterval(()=>{this.gameTime++},1e3)}applyMyBoardState(e){for(let t=0;t<this.boardSize;t++)for(let i=0;i<this.boardSize;i++){const n=e.cells[t][i],o=this.myCells[t][i];n.revealed&&(o.revealed=!0,o.adjacentCount=n.adjacentCount,n.shipId?o.hit=!0:n.hasMine?o.mine=!0:o.miss=!0)}}applyOpponentBoardState(e){for(let t=0;t<this.boardSize;t++)for(let i=0;i<this.boardSize;i++){const n=e.cells[t][i],o=this.opponentCells[t][i];o.adjacentCount=n.adjacentCount,n.revealed&&(o.revealed=!0,n.shipId?o.hit=!0:n.hasMine?o.mine=!0:o.miss=!0)}for(const t of e.ships){const i=this.getShipCells(t);for(const n of i){const o=this.opponentCells[n.y][n.x];o.sunk=!0,o.hit=!0,o.revealed=!0}}}coordToString(e,t){return`${String.fromCharCode(65+e)}${t+1}`}animateScan(){const i=()=>{let n=!1;const o=performance.now();for(const r of this.scanAnimations)if(r.phase==="scanning"){const a=o-r.startTime;r.progress=Math.min(a/600,1),r.progress>=1&&(r.phase="fading",r.alpha=1),n=!0}else r.phase==="fading"&&(r.alpha-=.03,r.alpha<=.3&&(r.phase="persistent",r.alpha=.3,this.activeScanZones.push({x:r.x,y:r.y,hasShips:r.hasShips})),n=!0);this.scanAnimations=this.scanAnimations.filter(r=>r.phase!=="persistent"),this.render(),n&&requestAnimationFrame(i)};requestAnimationFrame(i)}render(){this.renderBoard(this.selfCtx,this.myCells,!0),this.renderBoard(this.opponentCtx,this.opponentCells,!1)}renderBoard(e,t,i){e.clearRect(0,0,e.canvas.width,e.canvas.height),this.drawGrid(e),i&&this.myBoard&&(this.drawMyShips(e),this.drawMyMines(e)),this.drawCells(e,t,i),i||this.drawScanAnimations(e),!i&&this.hoverPosition&&this.isMyTurn&&this.drawHover(e)}drawGrid(e){const t=this.labelOffset;e.strokeStyle="#2a3f5f",e.lineWidth=1;for(let i=0;i<=this.boardSize;i++)e.beginPath(),e.moveTo(t+i*this.cellSize,t),e.lineTo(t+i*this.cellSize,t+this.boardSize*this.cellSize),e.stroke(),e.beginPath(),e.moveTo(t,t+i*this.cellSize),e.lineTo(t+this.boardSize*this.cellSize,t+i*this.cellSize),e.stroke();e.fillStyle="#8899aa",e.font="bold 12px Arial",e.textAlign="center",e.textBaseline="middle";for(let i=0;i<this.boardSize;i++)e.fillText(String.fromCharCode(65+i),t+i*this.cellSize+this.cellSize/2,t/2),e.fillText(String(i+1),t/2,t+i*this.cellSize+this.cellSize/2)}drawMyShips(e){if(!this.myBoard)return;const t=this.labelOffset;for(const i of this.myBoard.ships){const n=this.getShipCells(i),o=i.armorSegment!==null;for(let r=0;r<n.length;r++){const a=n[r],c=i.hits.includes(r),h=i.armorSegment===r&&!i.armorBroken;c?e.fillStyle="#ff4757":h?e.fillStyle="#ffd700":e.fillStyle="#3282b8",e.fillRect(t+a.x*this.cellSize+2,t+a.y*this.cellSize+2,this.cellSize-4,this.cellSize-4)}o&&!i.armorBroken&&(e.strokeStyle="#ffaa00",e.lineWidth=2,e.strokeRect(t+n[0].x*this.cellSize+2,t+n[0].y*this.cellSize+2,(i.rotation==="horizontal"?i.size*this.cellSize:this.cellSize)-4,(i.rotation==="vertical"?i.size*this.cellSize:this.cellSize)-4))}}drawMyMines(e){if(!this.myBoard)return;const t=this.labelOffset;e.fillStyle="#ff4757";for(const i of this.myBoard.mines){const n=this.myCells[i.y][i.x];n.revealed&&n.mine||(e.beginPath(),e.arc(t+i.x*this.cellSize+this.cellSize/2,t+i.y*this.cellSize+this.cellSize/2,this.cellSize/4,0,Math.PI*2),e.fill())}}drawCells(e,t,i){const n=this.labelOffset;for(let o=0;o<this.boardSize;o++)for(let r=0;r<this.boardSize;r++){const a=t[o][r];if(!a.revealed&&!a.armorHit&&!a.scouted&&!a.scoutPending)continue;const c=n+r*this.cellSize,h=n+o*this.cellSize;if(a.armorHit)e.fillStyle="rgba(255, 215, 0, 0.18)",e.fillRect(c+2,h+2,this.cellSize-4,this.cellSize-4),e.strokeStyle="#ffd700",e.lineWidth=3,e.beginPath(),e.moveTo(c+10,h+10),e.lineTo(c+this.cellSize-10,h+this.cellSize-10),e.moveTo(c+this.cellSize-10,h+10),e.lineTo(c+10,h+this.cellSize-10),e.stroke();else if(a.hit)e.fillStyle=a.sunk?"#8b0000":"#ff4757",e.fillRect(c+2,h+2,this.cellSize-4,this.cellSize-4),e.strokeStyle="#fff",e.lineWidth=3,e.beginPath(),e.moveTo(c+10,h+10),e.lineTo(c+this.cellSize-10,h+this.cellSize-10),e.moveTo(c+this.cellSize-10,h+10),e.lineTo(c+10,h+this.cellSize-10),e.stroke();else if(a.mine){e.fillStyle="#ff6b6b",e.beginPath(),e.arc(c+this.cellSize/2,h+this.cellSize/2,this.cellSize/3,0,Math.PI*2),e.fill(),e.strokeStyle="#ffd700",e.lineWidth=2;for(let u=0;u<8;u++){const m=u/8*Math.PI*2;e.beginPath(),e.moveTo(c+this.cellSize/2+Math.cos(m)*(this.cellSize/4),h+this.cellSize/2+Math.sin(m)*(this.cellSize/4)),e.lineTo(c+this.cellSize/2+Math.cos(m)*(this.cellSize/2.5),h+this.cellSize/2+Math.sin(m)*(this.cellSize/2.5)),e.stroke()}}else(a.miss||a.revealed)&&(e.fillStyle="rgba(100, 100, 100, 0.3)",e.fillRect(c+2,h+2,this.cellSize-4,this.cellSize-4),e.fillStyle="#666",e.beginPath(),e.arc(c+this.cellSize/2,h+this.cellSize/2,4,0,Math.PI*2),e.fill());if(a.adjacentCount>0&&(a.revealed||a.scouted)){e.font="bold 16px Arial",e.textAlign="center",e.textBaseline="middle";const u=["#00d9ff","#00ff88","#ffd700","#ff6b6b","#ff4757","#ff0000","#8b0000","#4a0000"];e.fillStyle=u[Math.min(a.adjacentCount-1,u.length-1)],e.fillText(String(a.adjacentCount),c+this.cellSize/2,h+this.cellSize/2)}a.scouted&&!a.revealed&&(e.strokeStyle="#00ff88",e.lineWidth=2,e.setLineDash([4,4]),e.strokeRect(c+2,h+2,this.cellSize-4,this.cellSize-4),e.setLineDash([])),a.scoutPending&&(e.strokeStyle="#ffaa00",e.lineWidth=2,e.setLineDash([2,2]),e.strokeRect(c+4,h+4,this.cellSize-8,this.cellSize-8),e.setLineDash([]),e.fillStyle="#ffaa00",e.beginPath(),e.arc(c+this.cellSize/2,h+this.cellSize/2,3,0,Math.PI*2),e.fill())}}drawScanAnimations(e){for(const t of this.scanAnimations)t.phase==="scanning"?this.drawScanningPhase(e,t):t.phase==="fading"&&this.drawFadingPhase(e,t);this.drawActiveScanZones(e)}drawScanningPhase(e,t){const i=this.labelOffset,n=t.hasShips?[255,71,87]:[0,217,255],o=t.hasShips?[255,150,150]:[150,230,255],r=Math.max(0,t.x-1),a=Math.min(this.boardSize-1,t.x+1),c=Math.max(0,t.y-1),h=Math.min(this.boardSize-1,t.y+1),u=a-r+1,m=Math.floor(t.progress*u),v=t.progress*u%1;for(let M=0;M<m;M++){const L=r+M;for(let O=c;O<=h;O++)e.fillStyle=`rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.25)`,e.fillRect(i+L*this.cellSize,i+O*this.cellSize,this.cellSize,this.cellSize)}if(m<u){const M=r+m;for(let L=c;L<=h;L++){const O=.5+v*.5;e.fillStyle=`rgba(${o[0]}, ${o[1]}, ${o[2]}, ${O})`,e.fillRect(i+M*this.cellSize,i+L*this.cellSize,this.cellSize,this.cellSize),e.strokeStyle=`rgba(255, 255, 255, ${.8*O})`,e.lineWidth=2,e.beginPath(),e.moveTo(i+M*this.cellSize+this.cellSize*v,i+L*this.cellSize),e.lineTo(i+M*this.cellSize+this.cellSize*v,i+(L+1)*this.cellSize),e.stroke()}}e.strokeStyle=`rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.8)`,e.lineWidth=2,e.setLineDash([5,5]),e.strokeRect(i+r*this.cellSize,i+c*this.cellSize,(a-r+1)*this.cellSize,(h-c+1)*this.cellSize),e.setLineDash([])}drawFadingPhase(e,t){const i=this.labelOffset,n=t.hasShips?[255,71,87]:[0,217,255],o=Math.max(0,t.x-1),r=Math.min(this.boardSize-1,t.x+1),a=Math.max(0,t.y-1),c=Math.min(this.boardSize-1,t.y+1);e.fillStyle=`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${t.alpha*.4})`;for(let h=o;h<=r;h++)for(let u=a;u<=c;u++)e.fillRect(i+h*this.cellSize,i+u*this.cellSize,this.cellSize,this.cellSize);e.strokeStyle=`rgba(${n[0]}, ${n[1]}, ${n[2]}, ${t.alpha})`,e.lineWidth=3,e.strokeRect(i+o*this.cellSize,i+a*this.cellSize,(r-o+1)*this.cellSize,(c-a+1)*this.cellSize)}drawActiveScanZones(e){const t=this.labelOffset;for(const i of this.activeScanZones){const n=i.hasShips?[255,71,87]:[0,217,255],o=Math.max(0,i.x-1),r=Math.min(this.boardSize-1,i.x+1),a=Math.max(0,i.y-1),c=Math.min(this.boardSize-1,i.y+1);e.fillStyle=`rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.1)`;for(let h=o;h<=r;h++)for(let u=a;u<=c;u++)e.fillRect(t+h*this.cellSize,t+u*this.cellSize,this.cellSize,this.cellSize);e.strokeStyle=`rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.7)`,e.lineWidth=3,e.strokeRect(t+o*this.cellSize+1,t+a*this.cellSize+1,(r-o+1)*this.cellSize-2,(c-a+1)*this.cellSize-2),e.strokeStyle=`rgba(${n[0]}, ${n[1]}, ${n[2]}, 0.3)`,e.lineWidth=1,e.setLineDash([3,3]),e.strokeRect(t+o*this.cellSize+4,t+a*this.cellSize+4,(r-o+1)*this.cellSize-8,(c-a+1)*this.cellSize-8),e.setLineDash([])}}drawHover(e){if(!this.hoverPosition)return;const t=this.labelOffset,{x:i,y:n}=this.hoverPosition;if(!this.opponentCells[n][i].revealed)if(this.abilityMode==="scan"){e.fillStyle="rgba(0, 217, 255, 0.2)",e.strokeStyle="#00d9ff",e.lineWidth=2;for(let r=-1;r<=1;r++)for(let a=-1;a<=1;a++){const c=i+a,h=n+r;c>=0&&c<this.boardSize&&h>=0&&h<this.boardSize&&e.fillRect(t+c*this.cellSize,t+h*this.cellSize,this.cellSize,this.cellSize)}}else if(this.abilityMode==="scout")e.fillStyle="rgba(0, 255, 136, 0.3)",e.strokeStyle="#00ff88",e.lineWidth=2,e.fillRect(t+i*this.cellSize,t+n*this.cellSize,this.cellSize,this.cellSize),e.strokeRect(t+i*this.cellSize+2,t+n*this.cellSize+2,this.cellSize-4,this.cellSize-4);else if(this.abilityMode==="flag"){e.fillStyle="rgba(255, 165, 2, 0.2)",e.fillRect(t+i*this.cellSize,t+n*this.cellSize,this.cellSize,this.cellSize);const r=t+i*this.cellSize+this.cellSize*.45,a=t+n*this.cellSize+this.cellSize*.2,c=this.cellSize*.6;e.strokeStyle="#ffa502",e.lineWidth=3,e.beginPath(),e.moveTo(r,a),e.lineTo(r,a+c),e.stroke(),e.fillStyle="#ff6b6b",e.beginPath(),e.moveTo(r,a),e.lineTo(r+this.cellSize*.3,a+this.cellSize*.12),e.lineTo(r,a+this.cellSize*.24),e.closePath(),e.fill()}else e.fillStyle="rgba(255, 255, 255, 0.2)",e.fillRect(t+i*this.cellSize,t+n*this.cellSize,this.cellSize,this.cellSize),e.strokeStyle="#fff",e.lineWidth=2,e.beginPath(),e.arc(t+i*this.cellSize+this.cellSize/2,t+n*this.cellSize+this.cellSize/2,this.cellSize/3,0,Math.PI*2),e.stroke(),e.beginPath(),e.moveTo(t+i*this.cellSize+this.cellSize/2,t+n*this.cellSize+5),e.lineTo(t+i*this.cellSize+this.cellSize/2,t+n*this.cellSize+this.cellSize-5),e.moveTo(t+i*this.cellSize+5,t+n*this.cellSize+this.cellSize/2),e.lineTo(t+i*this.cellSize+this.cellSize-5,t+n*this.cellSize+this.cellSize/2),e.stroke()}destroy(){this.gameTimeInterval&&clearInterval(this.gameTimeInterval)}}const be={menu:document.getElementById("menu-screen"),waiting:document.getElementById("waiting-screen"),placement:document.getElementById("placement-screen"),game:document.getElementById("game-screen"),gameover:document.getElementById("gameover-screen")},l={playerName:document.getElementById("player-name"),serverUrl:document.getElementById("server-url"),roomId:document.getElementById("room-id"),btnCreateRoom:document.getElementById("btn-create-room"),btnJoinRoom:document.getElementById("btn-join-room"),connectionStatus:document.getElementById("connection-status"),roomCode:document.getElementById("room-code"),waitingStatus:document.getElementById("waiting-status"),btnCopyRoom:document.getElementById("btn-copy-room"),btnCancelWaiting:document.getElementById("btn-cancel-waiting"),placementBoard:document.getElementById("placement-board"),shipsToPlace:document.getElementById("ships-to-place"),minesCounter:document.querySelector("#mines-counter span"),armorCounter:document.querySelector("#armor-counter span"),btnRotate:document.getElementById("btn-rotate"),btnClear:document.getElementById("btn-clear"),btnRandom:document.getElementById("btn-random"),btnReady:document.getElementById("btn-ready"),selfName:document.getElementById("self-name"),opponentName:document.getElementById("opponent-name"),selfLives:document.getElementById("self-lives"),opponentLives:document.getElementById("opponent-lives"),turnIndicator:document.getElementById("turn-indicator"),turnTimer:document.getElementById("turn-timer"),gameTimer:document.getElementById("game-timer"),selfBoard:document.getElementById("self-board"),opponentBoard:document.getElementById("opponent-board"),btnScan:document.getElementById("btn-scan"),btnScout:document.getElementById("btn-scout"),btnFlag:document.getElementById("btn-flag"),gameLog:document.getElementById("game-log"),btnMute:document.getElementById("btn-mute"),volumeSlider:document.getElementById("volume-slider"),audioControls:document.querySelector(".audio-controls"),audioDrag:document.getElementById("btn-audio-drag"),audioCollapse:document.getElementById("btn-audio-collapse"),abilitiesPanel:document.querySelector(".abilities-panel"),gameoverTitle:document.getElementById("gameover-title"),gameoverMessage:document.getElementById("gameover-message"),gameoverStats:document.getElementById("gameover-stats"),btnPlayAgain:document.getElementById("btn-play-again")};let w="",W="",B="",C=null,g=null,H="menu",q=null;const S={muted:!1,volume:.5,collapsed:!1,hasCustomPosition:!1,dragOffsetX:0,dragOffsetY:0};function k(s){Object.values(be).forEach(e=>e.classList.remove("active")),be[s].classList.add("active"),H=s}function de(s){l.waitingStatus.textContent=s}function Pe(){w="",W="",q=null,localStorage.removeItem("ms_player_id"),localStorage.removeItem("ms_room_id"),localStorage.removeItem("ms_player_name")}function qt(s){S.muted=s,y.setEnabled(!s),K()}function Ie(s){const e=Math.max(0,Math.min(1,s));S.volume=e,y.setVolume(e),e===0?(S.muted=!0,y.setEnabled(!1)):S.muted&&(S.muted=!1,y.setEnabled(!0)),K()}function K(){l.btnMute.classList.toggle("is-muted",S.muted),l.btnMute.setAttribute("aria-pressed",String(S.muted)),l.audioControls.classList.toggle("is-collapsed",S.collapsed);const s=l.btnMute.querySelector(".mute-icon"),e=l.btnMute.querySelector(".mute-text"),t=l.audioCollapse.querySelector("span");s&&(s.textContent=S.muted?"🔇":"🔊"),e&&(e.textContent=S.muted?"Со звуком":"Без звука"),t&&(t.textContent=S.collapsed?"▸":"▾")}function Ne(s,e,t=!1){const i=l.audioControls.closest(".game-container");if(!i)return;const n=i.getBoundingClientRect(),o=l.audioControls.getBoundingClientRect(),r=n.left+n.width-o.width-10,a=n.top+n.height-o.height-10,c=n.left+10,h=n.top+10,u=Math.min(Math.max(s,c),r),m=Math.min(Math.max(e,h),a);l.audioControls.style.left=`${u-n.left}px`,l.audioControls.style.top=`${m-n.top}px`,l.audioControls.style.right="auto",l.audioControls.style.bottom="auto",l.audioControls.style.transform="none",t&&(S.hasCustomPosition=!0)}function qe(){const s=l.audioControls.closest(".game-container");if(!s||S.hasCustomPosition)return;const e=s.getBoundingClientRect(),t=l.abilitiesPanel.getBoundingClientRect(),i=l.audioControls.getBoundingClientRect(),n=t.top+t.height/2-i.height/2,o=e.left+e.width-i.width-20;Ne(o,n)}function E(s,e="error"){l.connectionStatus.textContent=s,l.connectionStatus.className=`status ${e}`}function Vt(){const s="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let e="SHIP-";for(let t=0;t<4;t++)e+=s.charAt(Math.floor(Math.random()*s.length));return e}async function Ve(s){const e=l.playerName.value.trim(),t=l.serverUrl.value.trim(),i=localStorage.getItem("ms_player_id"),n=localStorage.getItem("ms_room_id"),o=localStorage.getItem("ms_player_name");if(!e){E("Введите ваше имя");return}if(!t){E("Введите адрес сервера");return}B=e;try{E("Подключение...","success"),l.btnCreateRoom.disabled=!0,l.btnJoinRoom.disabled=!0,await d.connect(t);const r=i&&n===s&&o===e?i:void 0;d.joinGame(s,e,r)}catch(r){E(`Ошибка: ${r.message}`),l.btnCreateRoom.disabled=!1,l.btnJoinRoom.disabled=!1}}l.btnCreateRoom.addEventListener("click",()=>{const s=Vt();l.roomId.value=s,Ve(s)});l.btnJoinRoom.addEventListener("click",()=>{const s=l.roomId.value.trim().toUpperCase();if(!s){E("Введите код комнаты");return}Ve(s)});l.btnCancelWaiting.addEventListener("click",()=>{d.leaveRoom(),d.disconnect(),Pe(),k("menu"),l.btnCreateRoom.disabled=!1,l.btnJoinRoom.disabled=!1});l.btnCopyRoom.addEventListener("click",async()=>{const s=l.roomCode.textContent?.trim();if(!s)return;const e=l.btnCopyRoom.textContent;try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(s);else{const t=document.createElement("textarea");t.value=s,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}l.btnCopyRoom.textContent="Скопировано"}catch{l.btnCopyRoom.textContent="Ошибка"}setTimeout(()=>{l.btnCopyRoom.textContent=e},1500)});l.btnRotate.addEventListener("click",()=>{C?.rotateSelectedShip()});l.btnClear.addEventListener("click",()=>{C?.clearBoard()});l.btnRandom.addEventListener("click",()=>{C?.randomPlacement()});l.btnReady.addEventListener("click",()=>{if(C?.isPlacementComplete()){const s=C.getPlacementData();d.placeShips(s),d.ready(),l.btnReady.disabled=!0,l.btnReady.textContent="Ожидание противника..."}});document.addEventListener("keydown",s=>{s.key.toLowerCase()==="r"&&C&&C.rotateSelectedShip()});l.btnScan.addEventListener("click",()=>{g?.setAbilityMode("scan")});l.btnScout.addEventListener("click",()=>{g?.setAbilityMode("scout")});l.btnFlag.addEventListener("click",()=>{g?.setAbilityMode("flag")});l.btnMute.addEventListener("click",()=>{qt(!S.muted)});l.volumeSlider.addEventListener("input",()=>{const s=Number(l.volumeSlider.value)/100;Ie(s)});l.audioCollapse.addEventListener("click",()=>{S.collapsed=!S.collapsed,K()});l.audioDrag.addEventListener("pointerdown",s=>{const e=l.audioControls.getBoundingClientRect();S.dragOffsetX=s.clientX-e.left,S.dragOffsetY=s.clientY-e.top,l.audioDrag.setPointerCapture(s.pointerId),l.audioControls.classList.add("is-dragging");const t=n=>{Ne(n.clientX-S.dragOffsetX,n.clientY-S.dragOffsetY,!0)},i=n=>{l.audioDrag.releasePointerCapture(n.pointerId),l.audioControls.classList.remove("is-dragging"),window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",i)};window.addEventListener("pointermove",t),window.addEventListener("pointerup",i)});l.btnPlayAgain.addEventListener("click",()=>{g?.destroy(),g=null,C=null,d.disconnect(),k("menu"),l.btnCreateRoom.disabled=!1,l.btnJoinRoom.disabled=!1,l.connectionStatus.textContent="",l.connectionStatus.className="status"});d.on("room_joined",s=>{w=s.playerId,W=s.roomId,localStorage.setItem("ms_player_id",s.playerId),localStorage.setItem("ms_room_id",s.roomId),localStorage.setItem("ms_player_name",B),l.roomCode.textContent=s.roomId,s.waitingForOpponent?(de("Ожидаем игрока"),k("waiting")):fe()});d.on("opponent_joined",s=>{console.log("Противник присоединился:",s.opponentName),fe()});d.on("opponent_disconnected",s=>{console.log("Противник отключился:",s.opponentName),(H==="game"||H==="placement")&&(q=H),de("Ожидаем пользователя"),k("waiting")});d.on("opponent_reconnected",s=>{console.log("Противник переподключился:",s.opponentName),q&&(k(q),q=null)});d.on("game_start",s=>{console.log("Игра началась!",s),Ft(s)});d.on("turn_result",s=>{g?.handleTurnResult(s)});d.on("scan_result",s=>{g?.handleScanResult(s)});d.on("scout_result",s=>{g?.handleScoutResult(s)});d.on("scout_sent",s=>{g?.handleScoutSent(s)});d.on("flag_result",s=>{g?.handleFlagResult(s)});d.on("opponent_action",s=>{g?.handleOpponentAction(s)});d.on("turn_changed",s=>{g?.handleTurnChanged(s)});d.on("timer_update",s=>{g?.handleTimerUpdate(s)});d.on("game_over",s=>{Gt(s)});d.on("sync_state",s=>{Dt(s)});d.on("room_closed",s=>{E(s.message||"Комната закрыта"),d.disconnect(),Pe(),k("menu"),l.btnCreateRoom.disabled=!1,l.btnJoinRoom.disabled=!1});d.on("error",s=>{console.error("Ошибка сервера:",s),E(`Ошибка: ${s.message}`)});d.on("disconnect",s=>{E("Соединение потеряно"),console.log("Отключение:",s?.reason)});d.on("socket_connected",()=>{W&&w&&B&&d.joinGame(W,B,w)});function fe(){k("placement"),C=new It(l.placementBoard,l.shipsToPlace,{onShipsChanged:re,onMinesChanged:s=>{l.minesCounter.textContent=String(p.MINES_COUNT-s)},onArmorChanged:s=>{l.armorCounter.textContent=String(p.MAX_ARMOR-s)}}),C.initialize(),re()}function Dt(s){const{gameState:e,yourBoard:t,opponentBoard:i}=s,n=$t(e,w),o=Ut(e,w);if(e.phase==="waiting"){de("Ожидаем пользователя"),k("waiting");return}if(e.phase==="placement"){fe(),C&&C.setPlacementData(ve(t)),n?.ready?(l.btnReady.disabled=!0,l.btnReady.textContent="Ожидание противника..."):re();return}k("game"),g&&g.destroy(),l.selfName.textContent=n?.name||B,l.opponentName.textContent=o?.name||"Противник",R(l.selfLives,n?.lives??p.MAX_LIVES),R(l.opponentLives,o?.lives??p.MAX_LIVES),g=new Be(l.selfBoard,l.opponentBoard,{playerId:w,isMyTurn:e.currentTurn===e.players.findIndex(r=>r?.id===w),onShoot:(r,a)=>d.shoot(r,a),onScan:(r,a)=>d.useScan(r,a),onScout:(r,a)=>d.useScout(r,a),onFlag:(r,a)=>d.useFlag(r,a),onLog:Ue,onTurnChange:X,onLivesChange:(r,a)=>{R(l.selfLives,r),R(l.opponentLives,a)},onAbilityUpdate:De,onAbilityModeChange:$e}),g.setMyBoard(ve(t)),g.initialize(),g.applySyncState(e,t,i,w),X(g.getIsMyTurn()),l.turnTimer.textContent=String(e.turnTimeLeft)}function $t(s,e){return s.players.find(t=>t?.id===e)||null}function Ut(s,e){return s.players.find(t=>t?.id!==e)||null}function ve(s){const e=s.ships.filter(t=>t.armorSegment!==null).map(t=>({shipId:t.id,segment:t.armorSegment}));return{ships:s.ships,mines:s.mines,armor:e}}function re(){const s=C?.isPlacementComplete()??!1;l.btnReady.disabled=!s}function Ft(s){k("game"),l.selfName.textContent=B,l.opponentName.textContent=s.opponentName,R(l.selfLives,p.MAX_LIVES),R(l.opponentLives,p.MAX_LIVES),g=new Be(l.selfBoard,l.opponentBoard,{playerId:s.yourPlayerId,isMyTurn:s.yourTurn,onShoot:(e,t)=>d.shoot(e,t),onScan:(e,t)=>d.useScan(e,t),onScout:(e,t)=>d.useScout(e,t),onFlag:(e,t)=>d.useFlag(e,t),onLog:Ue,onTurnChange:X,onLivesChange:(e,t)=>{R(l.selfLives,e),R(l.opponentLives,t)},onAbilityUpdate:De,onAbilityModeChange:$e}),C&&g.setMyBoard(C.getPlacementData()),g.initialize(),X(s.yourTurn)}function R(s,e){s.innerHTML="";for(let t=0;t<p.MAX_LIVES;t++){const i=document.createElement("div");i.className=`life${t>=e?" lost":""}`,s.appendChild(i)}}function X(s){l.turnIndicator.textContent=s?"Ваш ход":"Ход противника",l.turnIndicator.className=`turn-indicator ${s?"your-turn":"opponent-turn"}`}function De(s,e,t){const i=l.btnScan.querySelector(".ability-cooldown"),n=l.btnScout.querySelector(".ability-count"),o=l.btnScout.querySelector(".ability-cooldown");l.btnScan.disabled=s>0,i.textContent=s>0?`(${s} ходов)`:"",l.btnScout.disabled=e<=0||t>0,n.textContent=String(e),o.textContent=t>0?`(${t} ходов)`:""}function $e(s){l.btnScan.classList.toggle("active",s==="scan"),l.btnScout.classList.toggle("active",s==="scout"),l.btnFlag.classList.toggle("active",s==="flag")}function Ue(s,e="info"){const t=document.createElement("div");for(t.className=`log-entry log-${e}`,t.textContent=s,l.gameLog.insertBefore(t,l.gameLog.firstChild);l.gameLog.children.length>50;)l.gameLog.removeChild(l.gameLog.lastChild)}function Gt(s){k("gameover");const e=s.winner===w;l.gameoverTitle.textContent=e?"ПОБЕДА!":"ПОРАЖЕНИЕ",l.gameoverTitle.className=e?"victory":"defeat";const t={ships_destroyed:"Все корабли уничтожены",lives_depleted:"Закончились жизни",disconnect:"Противник отключился",timeout:"Время вышло"};l.gameoverMessage.textContent=t[s.reason]||"",l.gameoverStats.innerHTML=`
    <div class="stat-item">
      <span class="stat-label">Всего ходов:</span>
      <span class="stat-value">${s.stats.totalTurns}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Потоплено кораблей (вы):</span>
      <span class="stat-value">${s.stats.shipsDestroyed[0]}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Потоплено кораблей (противник):</span>
      <span class="stat-value">${s.stats.shipsDestroyed[1]}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Мин активировано:</span>
      <span class="stat-value">${s.stats.minesTriggered[0]} / ${s.stats.minesTriggered[1]}</span>
    </div>
  `}setInterval(()=>{if(g){const s=g.getGameTime(),e=Math.floor(s/60),t=s%60;l.gameTimer.textContent=`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`}},1e3);const Ht=Number(l.volumeSlider.value)/100;Ie(Ht);K();qe();window.addEventListener("resize",()=>{qe()});console.log("Морской Сапёр загружен!");
